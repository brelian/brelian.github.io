<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"0x400.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="IntroductionAs of the writing time, I have been working for over five years. In recent years, with the gradual accumulation of work experience, more and more colleagues and peers have approached me fo">
<meta property="og:type" content="article">
<meta property="og:title" content="Troubleshooting in Practice - connection leak detection as an example">
<meta property="og:url" content="https://0x400.com/experience/practice/troubleshooting-in-practice/index.html">
<meta property="og:site_name" content="Pylon PENG">
<meta property="og:description" content="IntroductionAs of the writing time, I have been working for over five years. In recent years, with the gradual accumulation of work experience, more and more colleagues and peers have approached me fo">
<meta property="og:locale">
<meta property="og:image" content="https://0x400.com/images/2023-10/troubleshooting-process.png">
<meta property="og:image" content="https://0x400.com/images/2023-10/log1.png">
<meta property="og:image" content="https://0x400.com/images/2023-10/log1.png">
<meta property="og:image" content="https://0x400.com/images/2023-10/log2.png">
<meta property="og:image" content="https://0x400.com/images/2023-10/log3.png">
<meta property="article:published_time" content="2023-10-11T14:45:49.000Z">
<meta property="article:modified_time" content="2025-10-06T14:24:15.147Z">
<meta property="article:author" content="Pylon, PENG">
<meta property="article:tag" content="Practice">
<meta property="article:tag" content="Troubleshooting">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://0x400.com/images/2023-10/troubleshooting-process.png">


<link rel="canonical" href="https://0x400.com/experience/practice/troubleshooting-in-practice/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-Hans","comments":true,"permalink":"https://0x400.com/experience/practice/troubleshooting-in-practice/","path":"experience/practice/troubleshooting-in-practice/","title":"Troubleshooting in Practice - connection leak detection as an example"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Troubleshooting in Practice - connection leak detection as an example | Pylon PENG</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.3.1/pdfobject.min.js","integrity":"sha256-jI72I8ZLVflVOisZIOaLvRew3tyvzeu6aZXFm7P7dEo="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js" defer></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.10.1/mermaid.min.js","integrity":"sha256-BmQmdWDS8X2OTbrwELWK366LV6escyWhHHe0XCTU/Hk="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Pylon PENG</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-1-Define-Problem"><span class="nav-number">2.</span> <span class="nav-text">Step 1: Define Problem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-2-Gather-Information"><span class="nav-number">3.</span> <span class="nav-text">Step 2: Gather Information</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-3-Reproduce-Problem"><span class="nav-number">4.</span> <span class="nav-text">Step 3: Reproduce Problem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-4-Investigate-Root-Cause"><span class="nav-number">5.</span> <span class="nav-text">Step 4: Investigate Root Cause</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-5-Fix-Problem"><span class="nav-number">6.</span> <span class="nav-text">Step 5: Fix Problem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-6-Validate-Solution"><span class="nav-number">7.</span> <span class="nav-text">Step 6: Validate Solution</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-7-Recap-and-Protection"><span class="nav-number">8.</span> <span class="nav-text">Step 7: Recap and Protection</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-8-Knowledge-Transfer"><span class="nav-number">9.</span> <span class="nav-text">Step 8: Knowledge Transfer</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Pylon, PENG</p>
  <div class="site-description" itemprop="description">这是 Pylon PENG 的个人博客，记录一些技术文章和生活琐事。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">87</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">88</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://0x400.com/experience/practice/troubleshooting-in-practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pylon, PENG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pylon PENG">
      <meta itemprop="description" content="这是 Pylon PENG 的个人博客，记录一些技术文章和生活琐事。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Troubleshooting in Practice - connection leak detection as an example | Pylon PENG">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Troubleshooting in Practice - connection leak detection as an example
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-10-11 22:45:49" itemprop="dateCreated datePublished" datetime="2023-10-11T22:45:49+08:00">2023-10-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-10-06 22:24:15" itemprop="dateModified" datetime="2025-10-06T22:24:15+08:00">2025-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/experience/" itemprop="url" rel="index"><span itemprop="name">Experience</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/experience/practice/" itemprop="url" rel="index"><span itemprop="name">Practice</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>As of the writing time, I have been working for over five years. In recent years, with the gradual accumulation of work experience, more and more colleagues and peers have approached me for help in solving challenging problems, such as Node.js memory leak detection, database connection pool leak detection (where connections are held for a long period), performance optimization, deadlock detection, among others. Today, I will use database connection pool leak detection as an example to summarize a set of approaches for troubleshooting complex issues for future reference - my best practices to troubleshooting.</p>
<p>Overall, my approach to analyzing complex issues can be broken down into eight steps.<br><img src="/images/2023-10/troubleshooting-process.png"></p>
<span id="more"></span>

<h2 id="Step-1-Define-Problem"><a href="#Step-1-Define-Problem" class="headerlink" title="Step 1: Define Problem"></a>Step 1: Define Problem</h2><p>The first and most crucial step in troubleshooting is to precisely define the problem. Start by gathering information about the issue. In the case of connection leak detection,</p>
<p><strong>The response was very slow, even with no response from Gateway but a 503 HTTP status code was responded.</strong></p>
<p>This is the definition of our problem which is very straightforward.</p>
<h2 id="Step-2-Gather-Information"><a href="#Step-2-Gather-Information" class="headerlink" title="Step 2: Gather Information"></a>Step 2: Gather Information</h2><p>The low response comes from kinds of possibilities. No hurry to investigate it immediately. Instead, to understand the problem better, we should collect as much information as possible. This may include environment, code version, logs, error messages, etc.</p>
<p>In our scenario, we found there was an endpoint &#x2F;metrics timeout from the logs. There wasn’t further information except for db connection failed to acquire.<br><img src="/images/2023-10/log1.png" alt="log1"></p>
<p>That means db connection pool was full always. We suspected some connections never had been released after used. We developed a detection algorithm in order to gather more logs about connection leak as below:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connectionMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>&lt;<span class="title class_">Connection</span>, <span class="title class_">IConInfo</span>&gt;();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">registerForLeaks</span>(<span class="params">label: string, con: Connection, stackErr?: <span class="built_in">Error</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (connectionMap.<span class="title function_">has</span>(con)) &#123; <span class="comment">// already register</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">info</span>: <span class="title class_">IConInfo</span> = &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="title function_">uuid</span>(),</span><br><span class="line">        stackErr,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Error</span>.<span class="title function_">captureStackTrace</span>(info, registerForLeaks); <span class="comment">// capture stack excluding current function</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">warnAfterUnusedMs</span>: number = (process.<span class="property">env</span>.<span class="property">DB_LEAK_WARN_AFTER_UNUSED</span> &amp;&amp; <span class="built_in">parseInt</span>(process.<span class="property">env</span>.<span class="property">DB_LEAK_WARN_AFTER_UNUSED</span>, <span class="number">10</span>)) || <span class="title class_">TimeUnit</span>.<span class="property">MINUTES</span>.<span class="title function_">toMillis</span>(<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">intervalMs</span>: number = (process.<span class="property">env</span>.<span class="property">DB_LEAK_INTERVAL_CHECK</span> &amp;&amp; <span class="built_in">parseInt</span>(process.<span class="property">env</span>.<span class="property">DB_LEAK_INTERVAL_CHECK</span>, <span class="number">10</span>)) || <span class="title class_">TimeUnit</span>.<span class="property">MINUTES</span>.<span class="title function_">toMillis</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> interval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!connectionMap.<span class="title function_">has</span>(con)) &#123;</span><br><span class="line">            <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> unusedSinceMs = <span class="title class_">Date</span>.<span class="title function_">now</span>() - (info.<span class="property">lastUsedTimeStamp</span> || info.<span class="property">connectionTimestamp</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove check after leak detection</span></span><br><span class="line">        <span class="keyword">if</span> (unusedSinceMs &gt; warnAfterUnusedMs) &#123;</span><br><span class="line">            <span class="title function_">logError</span>(</span><br><span class="line">                <span class="string">`[<span class="subst">$&#123;label&#125;</span>] probable connection leak detected with connection id: <span class="subst">$&#123;info.id&#125;</span>, unused since <span class="subst">$&#123;TimeUnit.MILLISECONDS.toMinutes(unusedSinceMs)&#125;</span> mins`</span>,</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">            map.<span class="title function_">delete</span>(con);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, intervalMs);</span><br><span class="line"></span><br><span class="line">    connectionMap.<span class="title function_">set</span>(con, info);</span><br><span class="line"></span><br><span class="line">    con.<span class="title function_">on</span>(<span class="string">&#x27;connected&#x27;</span>, <span class="function">(<span class="params">evt</span>) =&gt;</span> &#123;</span><br><span class="line">        info.<span class="property">connectionTimestamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">        <span class="title function_">logDebug</span>(<span class="string">`[<span class="subst">$&#123;label&#125;</span>] connected <span class="subst">$&#123;info.id&#125;</span> <span class="subst">$&#123;info.connectionTimestamp&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    con.<span class="title function_">on</span>(<span class="string">&#x27;disconnected&#x27;</span>, <span class="function">(<span class="params">evt</span>) =&gt;</span> &#123;</span><br><span class="line">        connectionMap.<span class="title function_">delete</span>(evt.<span class="property">connection</span>);</span><br><span class="line">        <span class="built_in">clearInterval</span>(interval);</span><br><span class="line">    &#125;);</span><br><span class="line">    con.<span class="title function_">on</span>(<span class="string">&#x27;executed&#x27;</span>, <span class="function">(<span class="params">evt</span>) =&gt;</span> &#123;</span><br><span class="line">        info.<span class="property">lastUsedTimeStamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">    con.<span class="title function_">on</span>(<span class="string">&#x27;prepared&#x27;</span>, <span class="function">(<span class="params">evt</span>) =&gt;</span> &#123;</span><br><span class="line">        info.<span class="property">lastUsedTimeStamp</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Step-3-Reproduce-Problem"><a href="#Step-3-Reproduce-Problem" class="headerlink" title="Step 3: Reproduce Problem"></a>Step 3: Reproduce Problem</h2><p>Before we diagnose the issue, much better if we were able to replicate it consistently. Reproducing the problem allows us to work with a controlled environment. To be able to narrow down the scope of the investigation.</p>
<h2 id="Step-4-Investigate-Root-Cause"><a href="#Step-4-Investigate-Root-Cause" class="headerlink" title="Step 4: Investigate Root Cause"></a>Step 4: Investigate Root Cause</h2><p>Now that we’ve reproduced the problem, it’s time to analyze the data we’ve collected. Look for patterns, anomalies, and potential causes.</p>
<p>Identifying the root cause is often the most challenging part of troubleshooting. We could follow the pattern ISOLATE-INVESTIGATE-VALIDATE to find the root cause in the end.</p>
<p>In our scenario, we found there was an endpoint &#x2F;metrics timeout from the logs</p>
<p><img src="/images/2023-10/log1.png" alt="log1"></p>
<p>Then we confined the investigation scope to &#x2F;metrics endpoint turned out there were actually lots of history logs pointed to this endpoint.</p>
<p><img src="/images/2023-10/log2.png" alt="log2"></p>
<p>Dug into more logs of metric endpoint, we found the connection acquired by <code>retriveErrorLocalizedStrings</code> had never been released.</p>
<p><img src="/images/2023-10/log3.png" alt="log3"></p>
<p>Looking at the corresponding code, we noticed a new connection was acquired occasionally for a new task in <code>retriveErrorLocalizedStrings</code>, but never released.</p>
<h2 id="Step-5-Fix-Problem"><a href="#Step-5-Fix-Problem" class="headerlink" title="Step 5: Fix Problem"></a>Step 5: Fix Problem</h2><p>Once we’ve identified the root cause, it’s time to fix the problem. This might involve writing code to address the issue, reconfiguring system settings, or applying a patch.</p>
<h2 id="Step-6-Validate-Solution"><a href="#Step-6-Validate-Solution" class="headerlink" title="Step 6: Validate Solution"></a>Step 6: Validate Solution</h2><p>After implementing your fix, it’s essential to validate the solution. Test our application again to ensure the problem no longer occurs.</p>
<h2 id="Step-7-Recap-and-Protection"><a href="#Step-7-Recap-and-Protection" class="headerlink" title="Step 7: Recap and Protection"></a>Step 7: Recap and Protection</h2><p>Troubleshooting shouldn’t end with the issue resolution. Take the time to recap what you’ve learned from the experience. Document the problem, the root cause, and the solution we applied. Consider implementing protective measures to prevent similar issues in the future.<br>In this example, we</p>
<ul>
<li><p>Fixed the problem</p>
</li>
<li><p>Enhanced connection lifecycle management: executeWithNewConnection</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> executeWithNewConnection&lt;T&gt;(</span><br><span class="line">    <span class="attr">connection</span>: <span class="title class_">Connection</span>,</span><br><span class="line">    <span class="attr">task</span>: <span class="title class_">Task</span>&lt;T&gt;,</span><br><span class="line">    taskName?: string</span><br><span class="line">): <span class="title class_">Promise</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> localTaskName = <span class="title function_">getTaskName</span>(taskName)</span><br><span class="line">    <span class="keyword">const</span> newConnection = <span class="title function_">createNewConnection</span>(connection)</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">run</span>(newConnection, task, localTaskName)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> run&lt;T&gt;(<span class="attr">newConnection</span>: <span class="title class_">Connection</span>, <span class="attr">task</span>: <span class="title class_">Task</span>&lt;T&gt;, <span class="attr">taskName</span>: string): <span class="title class_">Promise</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">task</span>(newConnection)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="attr">err</span>: any) &#123;</span><br><span class="line">        <span class="keyword">throw</span> err</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> newConnection.<span class="title function_">finish</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Whenever the task is run either successfully or failed, we finish the new connection. This means the lifecycle of this newly created connection was totally controlled.</p>
</li>
</ul>
<h2 id="Step-8-Knowledge-Transfer"><a href="#Step-8-Knowledge-Transfer" class="headerlink" title="Step 8: Knowledge Transfer"></a>Step 8: Knowledge Transfer</h2><p>The final step is to transfer knowledge to our team and other relevant stakeholders. Share our experience and the steps we took to resolve the issue. This not only fosters a culture of continuous improvement but also empowers our team to handle similar problems in the future.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/practice/" rel="tag"># Practice</a>
              <a href="/tags/troubleshooting/" rel="tag"># Troubleshooting</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/fundamental/algorithm/lc-binary-tree-template/" rel="prev" title="二叉树题解模版">
                  <i class="fa fa-angle-left"></i> 二叉树题解模版
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/experience/practice/middleware-installation-in-practice/" rel="next" title="Best Practices for Express Middleware Management">
                  Best Practices for Express Middleware Management <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Pylon, PENG</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
